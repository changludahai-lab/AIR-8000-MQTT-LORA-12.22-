# 室外声光报警器项目

## 项目概述

基于合宙 Air780EPM 模块的室外声光报警器设备，采用 LuaOS 开发。

### 主要功能

1. **报警功能**：接收报警/取消消息，触发/停止报警（LED灯闪烁 + TTS语音播报）
2. **双通讯模式**：支持 4G（MQTT）和 LORA 两种通讯方式，通过 GPIO 电平选择
3. **低功耗设计**：开机上电后自动进入 PSM 深度休眠模式，功耗可达微安级别
4. **智能唤醒**：支持 RTC 定时唤醒和雷达 IO 唤醒
5. **防重复唤醒**：30分钟内雷达不会重复唤醒设备
6. **远程升级**：4G 模式支持 FOTA 固件远程升级

---

## 硬件配置

### 模块信息
- **主控芯片**：Air780EPM（EC618 平台）
- **通讯方式**：4G LTE / LORA
- **音频芯片**：ES8311（I2C 控制 + I2S 数据）

### GPIO 引脚分配

| 引脚 | 功能 | 说明 |
|------|------|------|
| GPIO 1 | MODE_SELECT | 模式选择（0=4G，1=LORA）|
| GPIO 28 | LED_MAIN | 主指示灯 |
| GPIO 34-38 | LED_1 ~ LED_5 | 报警闪烁灯 |
| GPIO 22 | AUDIO_PA | 功放使能 |
| GPIO 20 | AUDIO_POWER | ES8311 电源控制 |
| GPIO 23 | FLOAT_INPUT | 浮空输入（需关闭防漏电）|
| WAKEUP0 | 雷达唤醒 | 4G模式下连接雷达传感器 |
| WAKEUP6 | 串口RI唤醒 | LORA模式下连接LORA模块 |

### 串口配置（LORA模式）
- **串口**：UART1
- **波特率**：9600
- **数据位**：8
- **停止位**：1

---

## 文件结构

```
├── main.lua          # 主入口文件，模式选择和状态机调度
├── config.lua        # 集中配置管理（所有常量和参数）
├── power.lua         # 电源管理（休眠、唤醒、低功耗）
├── alarm.lua         # 报警控制（LED闪烁、TTS语音）
├── comm_4g.lua       # 4G通讯（MQTT连接、消息收发、FOTA）
├── comm_lora.lua     # LORA通讯（串口收发、消息解析）
├── exaudio.lua       # 官方音频驱动库（不可修改）
└── README.md         # 本说明文档
```

---

## 工作模式

### 1. 4G 模式（GPIO1 = 低电平）

```
┌─────────────┐
│   设备启动   │
└──────┬──────┘
       ▼
┌─────────────┐
│  连接MQTT   │ 服务器：47.104.166.179:1883
└──────┬──────┘
       ▼
┌─────────────┐
│  进入PSM    │ 深度休眠，功耗最低
└──────┬──────┘
       │
   ┌───┴───┐
   ▼       ▼
┌─────┐ ┌─────┐
│RTC  │ │雷达 │ 唤醒源
│6小时│ │WAKEUP0│
└──┬──┘ └──┬──┘
   │       │
   ▼       ▼
上报状态  保持唤醒30分钟
   │       │ 等待报警指令
   ▼       ▼
┌─────────────┐
│  进入PSM    │
└─────────────┘
```

**MQTT Topic 格式**：
- 发布：`/780EHV/PUB/{IMEI}`
- 订阅：`/780EHV/SUB/{IMEI}`

**消息格式（JSON）**：
```json
{"type": "alarm"}    // 报警
{"type": "cancel"}   // 取消报警
{"type": "disarm"}   // 解除报警
```

### 2. LORA 模式（GPIO1 = 高电平）

```
┌─────────────┐
│   设备启动   │
└──────┬──────┘
       ▼
┌─────────────┐
│ 开启飞行模式 │ 关闭4G省电
└──────┬──────┘
       ▼
┌─────────────┐
│  初始化串口  │ UART1, 9600bps
└──────┬──────┘
       ▼
┌─────────────┐
│  进入PSM    │
└──────┬──────┘
       │
   ┌───┴───┐
   ▼       ▼
┌─────┐ ┌─────┐
│RTC  │ │串口RI│ 唤醒源
│6小时│ │WAKEUP6│
└──┬──┘ └──┬──┘
   │       │
   ▼       ▼
发送电量  保持唤醒30分钟
└─────────────┘
```

**LORA 消息协议**：

| 方向 | 消息 | 含义 |
|------|------|------|
| 接收 | C 或 CCCC | 报警指令 |
| 接收 | A 或 AAAA | 取消报警 |
| 接收 | B 或 BBBB | 解除报警 |
| 发送 | DDDD | 电池电量低 |
| 发送 | EEEE | 电池电量正常 |

---

## 核心功能说明

### 1. 报警功能

**触发条件**：收到 `alarm` 类型消息

**报警表现**：
- LED_MAIN 常亮
- LED_1 ~ LED_5 以 300ms 间隔交替闪烁
- TTS 语音循环播报："高液位报警，请立即停止卸油！"（每4秒一次）

**停止条件**：收到 `cancel` 或 `disarm` 消息

### 2. 低功耗管理

**功耗模式**：

| 模式 | 功耗 | 说明 |
|------|------|------|
| 正常运行 | ~100mA | CPU全速，外设开启 |
| 轻休眠 | ~10mA | CPU降频，可响应中断 |
| PSM深度休眠 | ~10μA | 仅保留RTC和唤醒源 |

**唤醒源配置**：
- **RTC定时器**：每6小时唤醒一次上报状态
- **WAKEUP0**（4G模式）：连接雷达传感器
- **WAKEUP6**（LORA模式）：连接串口RI引脚

### 3. 防重复唤醒机制

**需求**：30分钟内雷达不会重复唤醒

**实现原理**：
1. 使用 `fskv`（Flash KV存储）记录上次雷达唤醒时间
2. 每次 IO 唤醒时检查是否在冷却期内
3. 冷却期内直接进入 PSM，不处理

```lua
-- power.lua 中的冷却检查逻辑
if power.isRadarInCooldown() then
    log.info("main", "雷达在冷却期内，直接进入休眠")
    power.enterPSM()
    return
end
power.recordRadarWakeup()  -- 记录本次唤醒时间
```

### 4. FOTA 远程升级

**触发时机**：设备联网后自动检查

**升级流程**：
1. 连接合宙云平台
2. 比对 PROJECT 和 VERSION
3. 下载新固件
4. 重启安装

---

## 配置参数

所有可调参数集中在 `config.lua` 中：

### 电源管理
```lua
config.power = {
    wdt_timeout = 20000,              -- 看门狗超时 20秒
    wdt_feed_interval = 5000,         -- 喂狗间隔 5秒
    rtc_wakeup_interval = 6*60*60*1000,  -- RTC唤醒间隔 6小时
    radar_keep_awake_time = 30*60*1000,  -- 雷达唤醒后保持时间 30分钟
    radar_cooldown_time = 30*60*1000,    -- 雷达冷却时间 30分钟
    psm_fail_timeout = 15000,         -- PSM失败超时 15秒
}
```

### 报警配置
```lua
config.alarm = {
    led_flash_interval = 300,         -- LED闪烁间隔 300ms
    tts_repeat_interval = 4000,       -- TTS播报间隔 4秒
    tts_message = "高液位报警，请立即停止卸油！"
}
```

### MQTT配置
```lua
config.mqtt = {
    host = "47.104.166.179",
    port = 1883,
    keepalive = 240,                  -- 心跳间隔 4分钟
}
```

---

## 状态机流程

### 主状态机（main.lua）

```
┌──────────────────────────────────────────────────────────┐
│                      设备启动                             │
└────────────────────────┬─────────────────────────────────┘
                         ▼
              ┌─────────────────────┐
              │  读取 GPIO1 电平     │
              └──────────┬──────────┘
                         │
         ┌───────────────┴───────────────┐
         ▼                               ▼
    GPIO1 = 0                       GPIO1 = 1
    ┌─────────┐                     ┌─────────┐
    │ 4G模式  │                     │LORA模式 │
    └────┬────┘                     └────┬────┘
         │                               │
         ▼                               ▼
    关闭飞行模式                     开启飞行模式
    初始化MQTT                      初始化串口
         │                               │
         └───────────────┬───────────────┘
                         ▼
              ┌─────────────────────┐
              │  解析唤醒原因        │
              └──────────┬──────────┘
                         │
         ┌───────────────┼───────────────┐
         ▼               ▼               ▼
    ┌─────────┐    ┌─────────┐    ┌─────────┐
    │ 上电启动 │    │RTC唤醒  │    │ IO唤醒  │
    └────┬────┘    └────┬────┘    └────┬────┘
         │               │               │
         ▼               ▼               │
    等待5秒          上报状态            ▼
         │               │         检查冷却期
         │               │               │
         │               │    ┌──────────┴──────────┐
         │               │    ▼                     ▼
         │               │  在冷却期内          超过冷却期
         │               │    │                     │
         │               │    ▼                     ▼
         │               │  直接休眠           记录唤醒时间
         │               │                          │
         │               │                          ▼
         │               │                     上报状态
         │               │                          │
         │               │                          ▼
         │               │                   保持唤醒30分钟
         │               │                          │
         └───────────────┴──────────────────────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │    进入 PSM 休眠     │
              └─────────────────────┘
```

---

## 开发说明

### 环境要求
- LuaTools（合宙官方工具）
- Air780EPM 模块
- USB 转 TTL 调试器

### 烧录步骤
1. 打开 LuaTools
2. 选择正确的 COM 端口
3. 添加所有 `.lua` 文件
4. 点击"下载"

### 调试技巧

**查看日志**：
```lua
log.info("模块名", "消息内容", 变量...)
log.warn("模块名", "警告消息")
log.error("模块名", "错误消息")
```

**内存监控**：
```lua
log.info("mem", "lua", rtos.meminfo())
log.info("mem", "sys", rtos.meminfo("sys"))
```

---

## 常见问题

### 1. 设备无法进入 PSM
- 检查是否有未关闭的外设
- 检查 GPIO 是否处于浮空状态
- 查看日志是否有 PSM 失败提示

### 2. MQTT 连接失败
- 检查 SIM 卡是否正常
- 检查服务器地址和端口
- 确认网络信号强度

### 3. 语音播报无声音
- 检查 PA 和 ES8311 电源引脚
- 确认 I2C 和 I2S 初始化成功
- 检查音量设置

### 4. 雷达频繁唤醒
- 调整 `radar_cooldown_time` 参数
- 检查雷达灵敏度设置
- 确认 `fskv` 库是否可用

---

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| 001.000.000 | 2024-12 | 初始版本，基础功能实现 |
| 002.000.000 | 2024-12 | 重构代码，模块化设计，添加防重复唤醒机制 |

---

## 联系方式

如有问题，请联系项目维护人员。
