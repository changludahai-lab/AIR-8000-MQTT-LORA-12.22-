--[[
@module config
@summary 配置文件 - 集中管理所有常量和配置参数
@version 1.0.0

================================================================================
AIR8000 室内机配置文件
================================================================================

【设备定位】
AIR8000 是加油站液位监控系统的"室内机"，负责：
1. 采集液位仪数据（通过串口）
2. 判断是否存在高液位报警
3. 通过 4G(MQTT) 或 LORA 将报警指令发送给室外机(AIR780E)
4. 本机也有声光报警功能

【与室外机的关系】
┌─────────────┐                              ┌─────────────┐
│   AIR8000   │  ───MQTT/LORA报警指令───>    │   AIR780E   │
│   室内机    │  <───电池状态上报─────────    │   室外机    │
│             │                              │ 声光报警器   │
└─────────────┘                              └─────────────┘

【Python 类比】
这个文件类似 Python 项目中的 config.py 或 settings.py，
所有可配置参数集中在这里，避免"魔法数字"散落在代码各处。
]]

local config = {}

--------------------------------------------------------------------------------
-- 项目基本信息
-- 用于固件识别和 FOTA 远程升级
--------------------------------------------------------------------------------
config.PROJECT = "alarmer_8000_lora"  -- 项目名称
config.VERSION = "2.0.0"               -- 版本号（重构后升级为 2.0.0）
config.PRODUCT_KEY = "GYV9vpPCVN1uraiaPVXfvfTNXKInE58K"  -- 产品密钥

--------------------------------------------------------------------------------
-- GPIO 引脚定义
-- 这些数字对应 Air8000 模块的物理引脚
--
-- 【Python 类比】
-- 类似 RPi.GPIO 的 BCM 编号模式：
-- GPIO.setmode(GPIO.BCM)
-- LED_PIN = 17
--------------------------------------------------------------------------------
config.gpio = {
    -- 【模式选择引脚】
    -- 低电平(0) = 4G 模式（使用 MQTT 通讯）
    -- 高电平(1) = LORA 模式（使用串口+LORA 模块通讯）
    MODE_SELECT = 3,

    -- 【指示灯引脚】
    SYS_LED = 20,       -- 系统运行指示灯（上电常亮）
    NET_LED = 1,        -- 网络连接指示灯（联网后亮）
    ALARM_LED = 17,     -- 高液位报警指示灯
    BATTERY_LED = 16,   -- 室外机电池低电量指示灯

    -- 【输入引脚】
    LEVEL_INPUT = 2,    -- 液位报警 IO 输入（备用，液位仪直接输出高电平）
    KEY_CANCEL = 34,    -- 手动解除报警按键

    -- 【音频引脚】
    AUDIO_PA = 21,      -- 功放使能引脚
    AUDIO_POWER = 20    -- ES8311 电源控制引脚
}

--------------------------------------------------------------------------------
-- 串口配置
-- Air8000 使用两个串口：
-- 1. UART1 连接液位仪（维德路特/奥柯）
-- 2. UART11 连接 LORA 模块
--
-- 【Python 类比】
-- import serial
-- ser = serial.Serial('/dev/ttyUSB0', 9600, timeout=1)
--------------------------------------------------------------------------------
config.uart = {
    -- 液位仪串口
    level_sensor = {
        id = 1,          -- 串口编号
        baudrate = 9600, -- 波特率
        databits = 8,    -- 数据位
        stopbits = 1     -- 停止位
    },

    -- LORA 模块串口
    lora = {
        id = 11,         -- 串口编号（Air8000 的虚拟串口）
        baudrate = 9600,
        databits = 8,
        stopbits = 1
    }
}

--------------------------------------------------------------------------------
-- MQTT 配置
-- 4G 模式下使用 MQTT 协议与服务器通讯
--
-- 【工作原理】
-- 1. 室内机发布报警消息到 /AIR8000/PUB/{IMEI}
-- 2. 服务器转发到室外机的订阅 Topic
-- 3. 室外机收到后触发声光报警
--------------------------------------------------------------------------------
config.mqtt = {
    host = "47.104.166.179",    -- MQTT 服务器地址
    port = 1883,                 -- MQTT 端口（非加密）
    isssl = false,               -- 是否 SSL 加密

    user_name = "mqtt_user",     -- MQTT 用户名
    password = "mqtt_password",  -- MQTT 密码

    keepalive = 240,             -- 心跳保活（秒）

    -- Topic 前缀（实际 Topic = 前缀 + IMEI）
    pub_topic_prefix = "/AIR8000/PUB/",  -- 发布
    sub_topic_prefix = "/AIR8000/SUB/",  -- 订阅

    -- 连接参数
    connect_timeout = 30000,     -- 连接超时 30秒
    auto_reconnect = true        -- 自动重连
}

--------------------------------------------------------------------------------
-- 音频配置
-- 使用 ES8311 音频编解码芯片播放 TTS 语音
--------------------------------------------------------------------------------
config.audio = {
    -- 总线配置
    i2c_id = 0,
    i2s_id = 0,

    -- I2S 参数
    i2s_mode = 0,           -- 0=主机模式
    sample_rate = 16000,    -- 采样率 16kHz
    bits_per_sample = 16,   -- 16位采样
    channel_format = nil,   -- 将在运行时设置为 i2s.MONO_R
    comm_format = nil,      -- 将在运行时设置为 i2s.MODE_LSB
    channel_bits = 16,

    -- 音频通道
    multimedia_id = 0,

    -- 功放控制
    pa_on_level = 1,        -- PA 高电平开启
    power_on_level = 1,     -- ES8311 高电平供电
    power_delay = 3,        -- DAC 启动前延时（单位 100ms）
    pa_delay = 100,         -- PA 延时开启（单位 ms）
    power_time_delay = 100, -- 关闭时 PA 与 DAC 间隔

    -- 音量
    voice_vol = 75,         -- 播放音量（0-100）
    mic_vol = 80            -- 麦克风增益
}

--------------------------------------------------------------------------------
-- 报警配置
--------------------------------------------------------------------------------
config.alarm = {
    -- TTS 语音
    tts_high_level = "高液位报警，请立即停止卸油！",
    tts_battery_low = "灯光报警电量低，请更换",
    tts_alarm_cleared = "报警已解除！",

    -- 定时器间隔
    tts_repeat_interval = 4000,  -- TTS 播报间隔（ms）

    -- 按键解除后的冷却时间
    key_cooldown_time = 10 * 60 * 1000  -- 10分钟
}

--------------------------------------------------------------------------------
-- 液位仪配置
-- 支持多种品牌液位仪，通过串口协议识别
--
-- 【液位仪类型选择】
-- 修改 sensor_type 来切换不同品牌的液位仪：
-- "weidelu" = 维德路特
-- "aoke" = 奥科
--------------------------------------------------------------------------------
config.level_sensor = {
    -- 【液位仪类型】修改这里切换不同品牌
    sensor_type = "weidelu",  -- "weidelu" 或 "aoke"

    -- 轮询间隔
    poll_interval = 2000,  -- 每 2 秒查询一次液位仪

    -- 【维德路特协议】
    -- 发送: [0x01]i20500 (十六进制: 01 69 32 30 35 30 30)
    -- 响应: [0x01]i20500YYMMDDHHMMSS<罐数据>&&<校验>
    -- 罐数据格式: TTSS TTSS ... (TT=罐号, SS=状态)
    -- 状态码: 00=正常, 07=高液位报警
    weidelu = {
        query_cmd = "\x01i20500",  -- 查询命令
        header = "i205",            -- 响应头
    },

    -- 【奥科协议 (PD-3 Modbus RTU)】
    -- 发送: 01 03 00 04 00 00 04 0B (查询全部油罐报警信息)
    -- 响应: 01 03 <记录数> <罐号> <日期时间6字节> <报警码2字节> ...
    --
    -- 报警码说明:
    -- 00 0A = 高液位报警    ⚠️ 触发报警
    -- 00 0B = 高液位预警    ⚠️ 触发报警
    -- 00 0C = 低液位预警
    -- 00 0D = 低液位报警
    -- 00 0E = 水位高报警
    -- 00 0F = 测漏失败
    aoke = {
        query_cmd = "\x01\x03\x00\x04\x00\x00\x04\x0B",  -- 查询全部油罐报警
        header_byte1 = 0x01,  -- 设备地址
        header_byte2 = 0x03,  -- 功能码

        -- 需要触发报警的报警码
        alarm_codes = {
            HIGH_LEVEL_ALARM = 0x0A,    -- 高液位报警
            HIGH_LEVEL_WARNING = 0x0B,  -- 高液位预警
        }
    }
}

--------------------------------------------------------------------------------
-- LORA 消息协议
-- 与室外机(AIR780E)的通讯协议必须一致！
--
-- 【重要】这里定义的协议与室外机 config.lua 中的 lora_msg 对应
--------------------------------------------------------------------------------
config.lora_msg = {
    -- 【发送给室外机的指令】
    ALARM = "CCCC",       -- 报警指令（室外机收到 C 或 CCCC 都识别）
    CANCEL = "AAAA",      -- 取消报警
    DISARM = "BBBB",      -- 解除报警

    -- 【从室外机接收的状态】
    BATTERY_LOW = {"D", "DDDD"},   -- 电池低电量
    BATTERY_OK = {"E", "EEEE"},    -- 电池正常

    -- 电量阈值（用于 MQTT 模式判断）
    BATTERY_THRESHOLD = 3300  -- 3.3V
}

--------------------------------------------------------------------------------
-- MQTT 消息格式
-- 与室外机的消息格式统一
--
-- 【重要】室外机期望的格式是 {type: "alarm"} 等
-- 原代码使用 {bj: 1} 格式，需要统一
--------------------------------------------------------------------------------
config.mqtt_msg = {
    -- 发送给室外机的消息类型
    TYPE_ALARM = "alarm",     -- 报警
    TYPE_CANCEL = "cancel",   -- 取消报警
    TYPE_DISARM = "disarm"    -- 解除报警
}

--------------------------------------------------------------------------------
-- 看门狗配置
--------------------------------------------------------------------------------
config.watchdog = {
    timeout = 15000,      -- 超时时间 15秒
    feed_interval = 2000  -- 喂狗间隔 2秒
}

--------------------------------------------------------------------------------
-- DNS 配置
-- 备用 DNS 服务器，提高域名解析稳定性
--------------------------------------------------------------------------------
config.dns = {
    primary = "223.5.5.5",       -- 阿里云 DNS
    secondary = "114.114.114.114" -- 国内通用 DNS
}

--------------------------------------------------------------------------------
-- 返回配置表
--------------------------------------------------------------------------------
return config
