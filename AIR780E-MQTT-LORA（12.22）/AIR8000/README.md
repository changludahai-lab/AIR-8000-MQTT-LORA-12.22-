# AIR8000 室内机项目

## 项目概述

基于合宙 Air8000 模块的加油站液位监控室内机，采用 LuaOS 开发。

### 系统定位

AIR8000 是加油站液位监控系统的**室内机**（主控制器），与室外机(AIR780E)共同组成完整的报警系统：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            加油站液位监控系统                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────┐                                    ┌───────────────┐    │
│  │   液位仪       │                                    │   AIR780E     │    │
│  │(维德路特/奥柯) │                                    │   室外机      │    │
│  └───────┬───────┘                                    └───────▲───────┘    │
│          │ RS485/RS232                                        │            │
│          ▼                                              MQTT/LORA         │
│  ┌───────────────────────────────────────────────────────────┐│            │
│  │                      AIR8000 室内机                        ││            │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        ││            │
│  │  │level_sensor │→ │   alarm     │→ │ comm_mqtt   │────────┘│            │
│  │  │ 液位采集    │  │ 本机报警    │  │ comm_lora   │─────────┘            │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                      │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 主要功能

1. **液位采集**：通过串口读取液位仪数据，支持维德路特、奥柯等品牌
2. **双通讯模式**：支持 4G（MQTT）和 LORA 两种通讯方式，通过 GPIO 电平选择
3. **本机报警**：高液位时本机 LED 亮 + TTS 语音播报
4. **远程报警**：发送报警指令给室外机(AIR780E)触发声光报警
5. **手动解除**：按键解除报警，带冷却期防止误操作
6. **远程升级**：4G 模式支持 FOTA 固件远程升级

---

## 硬件配置

### 模块信息
- **主控芯片**：Air8000
- **通讯方式**：4G LTE / LORA
- **音频芯片**：ES8311（I2C 控制 + I2S 数据）

### GPIO 引脚分配

| 引脚 | 功能 | 说明 |
|------|------|------|
| GPIO 3 | MODE_SELECT | 模式选择（0=4G，1=LORA）|
| GPIO 20 | SYS_LED | 系统运行指示灯（上电常亮）|
| GPIO 1 | NET_LED | 网络连接指示灯 |
| GPIO 17 | ALARM_LED | 高液位报警指示灯 |
| GPIO 16 | BATTERY_LED | 室外机电池低电量指示灯 |
| GPIO 2 | LEVEL_INPUT | 液位报警 IO 输入（备用）|
| GPIO 34 | KEY_CANCEL | 手动解除报警按键 |
| GPIO 21 | AUDIO_PA | 功放使能 |
| GPIO 20 | AUDIO_POWER | ES8311 电源控制 |

### 串口配置

| 串口 | 用途 | 波特率 |
|------|------|--------|
| UART1 | 液位仪通讯 | 9600 |
| UART11 | LORA 模块通讯 | 9600 |

---

## 文件结构

```
AIR8000/
├── main.lua           # 主入口文件，模式选择和业务调度
├── config.lua         # 集中配置管理（GPIO、MQTT、串口参数）
├── level_sensor.lua   # 液位仪模块（串口通讯、协议解析）
├── alarm.lua          # 报警模块（LED控制、TTS语音）
├── comm_mqtt.lua      # MQTT通讯模块（4G模式）
├── comm_lora.lua      # LORA通讯模块
├── exaudio.lua        # 官方音频驱动库（不可修改）
└── README.md          # 本说明文档
```

---

## 工作模式

### 1. 4G 模式（GPIO3 = 低电平）

```
┌─────────────┐
│   设备启动   │
└──────┬──────┘
       ▼
┌─────────────┐
│  连接MQTT   │ 服务器：47.104.166.179:1883
└──────┬──────┘
       ▼
┌─────────────┐
│  初始化液位仪│
└──────┬──────┘
       ▼
┌─────────────┐       ┌─────────────┐
│  轮询液位    │──────→│  检测高液位  │
└──────┬──────┘       └──────┬──────┘
       │                     │
       │              ┌──────┴──────┐
       │              ▼             ▼
       │         高液位          正常
       │              │             │
       │              ▼             ▼
       │         本机报警       取消报警
       │         发送MQTT      发送MQTT
       │              │             │
       └──────────────┴─────────────┘
```

**MQTT Topic 格式**：
- 发布：`/AIR8000/PUB/{IMEI}`
- 订阅：`/AIR8000/SUB/{IMEI}`

**消息格式（JSON）**：
```json
{"type": "alarm"}    // 报警
{"type": "cancel"}   // 取消报警
{"type": "disarm"}   // 解除报警
```

### 2. LORA 模式（GPIO3 = 高电平）

```
┌─────────────┐
│   设备启动   │
└──────┬──────┘
       ▼
┌─────────────┐
│ 开启飞行模式 │ 关闭4G省电
└──────┬──────┘
       ▼
┌─────────────┐
│  初始化串口  │ UART11, 9600bps
└──────┬──────┘
       ▼
┌─────────────┐
│  初始化液位仪│
└──────┬──────┘
       ▼
┌─────────────┐       ┌─────────────┐
│  轮询液位    │──────→│  检测高液位  │
└─────────────┘       └──────┬──────┘
                             │
                      ┌──────┴──────┐
                      ▼             ▼
                 高液位          正常
                      │             │
                      ▼             ▼
                 发送 CCCC     发送 AAAA
                 (报警)        (取消)
```

**LORA 消息协议**：

| 方向 | 消息 | 含义 |
|------|------|------|
| 发送 | CCCC | 报警指令 |
| 发送 | AAAA | 取消报警 |
| 发送 | BBBB | 解除报警 |
| 接收 | D 或 DDDD | 室外机电池低电量 |
| 接收 | E 或 EEEE | 室外机电池正常 |

---

## 液位仪协议

### 维德路特(Veeder-Root)

**查询命令**：`[0x01]i20500`

**响应格式**：
```
[0x01]i205<罐数><年月日><时分秒><罐1数据>...<罐N数据>&&<校验>
```

每个罐数据 59 字节，状态字节位于偏移 +3 位置：
- `0x0A` = 高液位报警

### 奥柯(Aoke) - Modbus RTU

**查询命令**：`01 04 01 01 00 00 A0 36`

**响应格式**：
```
01 04 <罐数> <年> <月日> <时分秒> <罐1数据>...<罐N数据>
```

---

## 核心功能说明

### 1. 高液位报警流程

```
液位仪检测到高液位
       │
       ▼
┌─────────────────┐
│ levelSensor 模块│ 解析串口数据
│ isHighLevel()=true
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   main.lua      │ 主循环检测到状态变化
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌───────┐ ┌────────┐
│ alarm │ │ comm   │
│模块   │ │模块    │
│本机报警│ │发送指令│
└───────┘ └────────┘
    │         │
    ▼         ▼
LED亮    MQTT/LORA
TTS播报  → 室外机
```

### 2. 手动解除报警

- 按下 GPIO34 按键
- 停止本机报警
- 播放"报警已解除"语音
- 发送解除指令给室外机
- 进入 10 分钟冷却期（防止误操作后立即再次报警）

### 3. 室外机电池监控

- 4G模式：通过 MQTT 接收 `{vbat: xxx}` 消息
- LORA模式：通过串口接收 `DDDD`/`EEEE` 消息
- 电压低于 3.3V 时点亮电池低电量指示灯并语音提示

---

## 配置参数

所有可调参数集中在 `config.lua` 中：

### MQTT配置
```lua
config.mqtt = {
    host = "47.104.166.179",
    port = 1883,
    keepalive = 240,  -- 心跳间隔 4分钟
}
```

### 报警配置
```lua
config.alarm = {
    tts_high_level = "高液位报警，请立即停止卸油！",
    tts_battery_low = "灯光报警电量低，请更换",
    tts_repeat_interval = 4000,      -- TTS播报间隔 4秒
    key_cooldown_time = 10*60*1000,  -- 按键冷却 10分钟
}
```

### 液位仪配置
```lua
config.level_sensor = {
    poll_interval = 2000,  -- 轮询间隔 2秒
}
```

---

## 与室外机(AIR780E)的协议对照

| 场景 | 室内机发送 | 室外机接收处理 |
|------|------------|----------------|
| 高液位报警 | MQTT: `{type:"alarm"}` 或 LORA: `CCCC` | 启动报警（LED闪烁+TTS） |
| 取消报警 | MQTT: `{type:"cancel"}` 或 LORA: `AAAA` | 停止报警，进入休眠 |
| 解除报警 | MQTT: `{type:"disarm"}` 或 LORA: `BBBB` | 停止报警，进入休眠 |
| 电池状态 | 室外机上报 `{vbat:xxx}` 或 `DDDD`/`EEEE` | 室内机显示电池指示 |

---

## 开发说明

### 环境要求
- LuaTools（合宙官方工具）
- Air8000 模块
- USB 转 TTL 调试器

### 烧录步骤
1. 打开 LuaTools
2. 选择正确的 COM 端口
3. 添加所有 `.lua` 文件
4. 点击"下载"

### 调试技巧

**查看日志**：
```lua
log.info("模块名", "消息内容", 变量...)
log.warn("模块名", "警告消息")
log.error("模块名", "错误消息")
```

**内存监控**：
```lua
log.info("mem", "lua", rtos.meminfo())
log.info("mem", "sys", rtos.meminfo("sys"))
```

---

## 常见问题

### 1. 液位仪数据解析失败
- 检查串口接线（TX/RX是否交叉）
- 确认波特率设置正确（默认9600）
- 查看日志中的原始数据是否符合协议

### 2. MQTT 连接失败
- 检查 SIM 卡是否正常
- 检查服务器地址和端口
- 确认网络信号强度

### 3. LORA 通讯不稳定
- 检查 LORA 模块配置（频率、扩频因子等）
- 确认室内外机 LORA 参数一致
- 检查天线连接

### 4. 语音播报无声音
- 检查 PA 和 ES8311 电源引脚
- 确认 I2C 和 I2S 初始化成功
- 检查音量设置

---

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| 1.0.0 | 2024-12 | 初始版本 |
| 2.0.0 | 2024-12 | 重构代码，模块化设计，修复液位协议解析bug，统一消息格式 |

---

## 联系方式

如有问题，请联系项目维护人员。
