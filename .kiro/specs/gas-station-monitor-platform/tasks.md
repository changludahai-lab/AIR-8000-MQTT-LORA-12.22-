# 实现计划：加油站液位监控 WEB 管理平台

## 概述

本计划将设计文档转化为可执行的开发任务，采用增量开发方式，每个任务都在前一个任务的基础上构建。

## 任务列表

- [x] 1. 项目初始化和基础架构搭建
  - [x] 1.1 创建 Flask 项目结构和配置文件
    - 创建 backend/ 目录结构
    - 创建 config.py 配置文件（数据库连接、JWT 密钥、MQTT 配置）
    - 创建 requirements.txt 依赖文件
    - _需求: 9.4_
  - [x] 1.2 配置 SQLAlchemy 和数据库连接
    - 初始化 Flask-SQLAlchemy
    - 配置 MySQL 连接
    - 实现数据库自动创建逻辑
    - _需求: 8.1, 8.2_
  - [x] 1.3 创建数据模型
    - 创建 User 模型（用户表）
    - 创建 Station 模型（加油站表）
    - 创建 Device 模型（设备表）
    - 创建 AlarmLog 模型（报警日志表）
    - 创建 user_stations 关联表
    - _需求: 8.3_

- [x] 2. 用户认证模块
  - [x] 2.1 实现 JWT 认证
    - 配置 Flask-JWT-Extended
    - 实现登录接口 POST /api/auth/login
    - 实现登出接口 POST /api/auth/logout
    - 实现获取当前用户接口 GET /api/auth/me
    - _需求: 1.1, 1.2, 1.3, 1.4_
  - [x] 2.2 实现默认管理员创建
    - 应用启动时检查 admin 用户是否存在
    - 不存在则创建默认超级管理员（admin/admin123）
    - _需求: 1.5_
  - [ ]* 2.3 编写认证模块属性测试
    - **属性 1: 认证令牌有效性**
    - **属性 2: 无效凭证拒绝**
    - **验证需求: 1.2, 1.3**

- [x] 3. 用户管理模块
  - [x] 3.1 实现用户 CRUD API
    - 实现获取用户列表 GET /api/users
    - 实现创建用户 POST /api/users
    - 实现更新用户 PUT /api/users/{id}
    - 实现删除用户 DELETE /api/users/{id}
    - _需求: 2.1, 2.2, 2.3, 2.4_
  - [x] 3.2 实现角色权限控制
    - 创建权限装饰器 @admin_required
    - 普通用户访问用户管理 API 返回 403
    - _需求: 2.5, 2.6_
  - [ ]* 3.3 编写用户管理属性测试
    - **属性 3: 用户数据持久化**
    - **属性 4: 角色权限控制**
    - **验证需求: 2.2, 2.3, 2.4, 2.5, 2.6**

- [x] 4. 加油站管理模块
  - [x] 4.1 实现加油站 CRUD API
    - 实现获取加油站列表 GET /api/stations（支持分页、搜索）
    - 实现创建加油站 POST /api/stations
    - 实现获取加油站详情 GET /api/stations/{id}
    - 实现更新加油站 PUT /api/stations/{id}
    - 实现删除加油站 DELETE /api/stations/{id}（检查绑定设备）
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_
  - [ ]* 4.2 编写加油站管理属性测试
    - **属性 5: 加油站数据持久化**
    - **属性 6: 加油站删除保护**
    - **属性 7: 加油站搜索准确性**
    - **验证需求: 3.2, 3.3, 3.4, 3.5**

- [x] 5. 设备管理模块
  - [x] 5.1 实现设备查询 API
    - 实现获取设备列表 GET /api/devices（支持筛选、搜索）
    - 实现获取设备详情 GET /api/devices/{imei}
    - _需求: 4.2, 4.3, 4.7, 4.8_
  - [x] 5.2 实现设备绑定/解绑 API
    - 实现绑定设备 POST /api/devices/{imei}/bind
    - 实现解绑设备 POST /api/devices/{imei}/unbind
    - 室内机绑定时检查加油站是否已有室内机
    - _需求: 4.4, 4.5, 4.6_
  - [ ]* 5.3 编写设备管理属性测试
    - **属性 9: 室内机绑定唯一性**
    - **属性 10: 室外机绑定无限制**
    - **属性 11: 设备解绑有效性**
    - **验证需求: 4.4, 4.5, 4.6**

- [x] 6. 检查点 - 后端 API 基础功能
  - 确保所有 API 测试通过
  - 确保数据库操作正常
  - 如有问题请询问用户

- [x] 7. MQTT 转发服务
  - [x] 7.1 实现 MQTT 客户端连接
    - 使用 paho-mqtt 连接 MQTT Broker
    - 订阅 /AIR8000/PUB/+ 和 /780EHV/PUB/+
    - _需求: 6.4_
  - [x] 7.2 实现设备自动注册
    - 收到消息时检查设备是否存在
    - 不存在则自动创建设备记录
    - 更新设备 last_seen 时间
    - _需求: 4.1, 5.1_
  - [x] 7.3 实现消息转发逻辑
    - 室内机消息转发给同站所有室外机
    - 室外机消息转发给同站室内机
    - 未绑定设备消息不转发
    - _需求: 6.1, 6.2, 6.3, 6.5_
  - [x] 7.4 实现报警日志记录
    - 室内机报警消息（bj=1）记录报警日志
    - 室内机取消消息（bj=0）记录取消日志
    - 记录完整信息（时间、加油站、IMEI、类型、转发列表、状态）
    - _需求: 7.1, 7.2, 7.3_
  - [ ]* 7.5 编写 MQTT 转发属性测试
    - **属性 8: 设备自动注册**
    - **属性 12: 设备在线时间更新**
    - **属性 14: 消息转发完整性**
    - **属性 15: 未绑定设备消息忽略**
    - **属性 16: 报警日志记录完整性**
    - **验证需求: 4.1, 5.1, 6.1, 6.2, 6.3, 7.1, 7.2, 7.3**

- [x] 8. 设备状态和报警日志查询
  - [x] 8.1 实现设备在线状态计算
    - 查询时计算在线状态（last_seen 超过 13 小时为离线）
    - 返回低电量警告（vbat < 3300）
    - _需求: 5.2, 5.4_
  - [x] 8.2 实现报警日志查询 API
    - 实现获取报警日志 GET /api/alarms（支持筛选、搜索、分页）
    - 按时间倒序返回
    - _需求: 7.4, 7.5, 7.6_
  - [ ]* 8.3 编写状态和日志属性测试
    - **属性 13: 离线状态判定**
    - **属性 17: 日志时间排序**
    - **验证需求: 5.2, 7.4**

- [x] 9. 检查点 - 后端功能完成
  - 确保所有后端 API 测试通过
  - 确保 MQTT 转发服务正常工作
  - 如有问题请询问用户

- [x] 10. 前端项目初始化
  - [x] 10.1 创建 Vue3 项目
    - 使用 Vite 创建 Vue3 项目
    - 安装 Element Plus、Vue Router、Pinia、Axios
    - 配置项目结构
    - _需求: 9.1_
  - [x] 10.2 配置路由和状态管理
    - 配置 Vue Router 路由
    - 配置 Pinia 状态管理
    - 实现路由守卫（未登录跳转登录页）
    - _需求: 1.1_
  - [x] 10.3 封装 API 调用
    - 创建 Axios 实例
    - 配置请求拦截器（添加 JWT Token）
    - 配置响应拦截器（处理 401 错误）
    - _需求: 9.2_

- [x] 11. 前端页面开发 - 认证和用户
  - [x] 11.1 实现登录页面
    - 创建 Login.vue 页面
    - 实现登录表单和验证
    - 登录成功保存 Token 并跳转首页
    - _需求: 1.2, 1.3_
  - [x] 11.2 实现布局组件
    - 创建 Layout.vue 布局组件
    - 创建 Sidebar.vue 侧边栏（根据角色显示/隐藏菜单）
    - 创建 Header.vue 头部（显示用户信息、退出按钮）
    - _需求: 1.4, 2.5_
  - [x] 11.3 实现用户管理页面
    - 创建 Users.vue 页面
    - 实现用户列表展示
    - 实现新增/编辑/删除用户功能
    - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 12. 前端页面开发 - 加油站和设备
  - [x] 12.1 实现加油站管理页面
    - 创建 Stations.vue 页面
    - 实现加油站列表（分页、搜索）
    - 实现新增/编辑/删除加油站功能
    - 实现加油站详情弹窗（显示绑定设备）
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_
  - [x] 12.2 实现设备管理页面
    - 创建 Devices.vue 页面
    - 实现设备列表（筛选、搜索）
    - 实现设备绑定/解绑功能
    - _需求: 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8_
  - [x] 12.3 实现设备监控页面
    - 创建 Monitor.vue 页面
    - 实现设备状态实时展示（在线/离线/低电量）
    - 实现定时刷新
    - _需求: 5.2, 5.3, 5.4, 5.5_

- [x] 13. 前端页面开发 - 报警日志和首页
  - [x] 13.1 实现报警日志页面
    - 创建 Alarms.vue 页面
    - 实现日志列表（筛选、搜索、分页）
    - 按时间倒序显示
    - _需求: 7.4, 7.5, 7.6_
  - [x] 13.2 实现首页仪表盘
    - 创建 Dashboard.vue 页面
    - 显示加油站总数、设备总数、在线设备数
    - 显示最近报警记录
    - _需求: 无特定需求，提升用户体验_

- [x] 14. 前端构建和集成
  - [x] 14.1 构建前端静态文件
    - 执行 npm run build
    - 将 dist 目录复制到 Flask static 目录
    - _需求: 9.1_
  - [x] 14.2 配置 Flask 托管前端
    - 配置 Flask 路由返回 index.html
    - 配置静态文件路由
    - _需求: 9.1, 9.3_

- [x] 15. 最终检查点
  - 确保所有功能正常工作
  - 确保前后端集成正常
  - 确保 python app.py 可以启动完整应用
  - 如有问题请询问用户

## 备注

- 标记 `*` 的任务为可选任务（属性测试），可根据时间跳过
- 每个任务都引用了对应的需求编号，确保需求覆盖
- 检查点任务用于阶段性验证，确保增量开发的稳定性
