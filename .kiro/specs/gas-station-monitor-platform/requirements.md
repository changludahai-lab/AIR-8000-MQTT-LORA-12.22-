# 需求文档

## 简介

加油站液位监控 WEB 管理平台，用于管理加油站、设备（室内机/室外机）、用户权限，并实现 MQTT 消息转发和报警日志记录。该平台替代现有的 Data_Forwarding.py 简易上位机，提供完整的可视化管理界面。

## 术语表

- **平台**: 加油站液位监控 WEB 管理平台
- **室内机**: AIR8000 设备，负责采集液位数据并发送报警
- **室外机**: AIR780EPM 设备，接收报警指令并触发声光报警
- **加油站**: 设备的归属单位
- **超级管理员**: 拥有所有权限的用户角色
- **普通用户**: 只能查看数据，无法管理用户的角色
- **IMEI**: 设备唯一标识码
- **绑定**: 设备与加油站的关联关系
- **MQTT转发服务**: 负责在室内机和室外机之间转发消息的后台服务

## 需求列表

### 需求 1：用户认证

**用户故事：** 作为用户，我希望通过用户名和密码登录系统，以便安全地访问平台。

#### 验收标准

1. 当用户未登录访问平台时，平台应跳转到登录页面
2. 当用户提交正确的用户名和密码时，平台应生成 JWT 令牌并允许访问
3. 当用户提交错误的用户名或密码时，平台应显示错误提示并拒绝访问
4. 当用户点击退出登录时，平台应清除登录状态并跳转到登录页面
5. 平台首次启动时应自动创建默认超级管理员账号（用户名：admin，密码：admin123）

### 需求 2：用户管理

**用户故事：** 作为超级管理员，我希望管理用户账号，以便控制谁可以访问平台。

#### 验收标准

1. 当超级管理员访问用户管理页面时，平台应显示所有用户列表
2. 当超级管理员创建新用户时，平台应保存用户名、密码和角色信息
3. 当超级管理员编辑用户时，平台应更新用户信息
4. 当超级管理员删除用户时，平台应从系统中移除该用户
5. 当普通用户登录时，平台应隐藏用户管理菜单
6. 平台应支持两种角色：超级管理员和普通用户

### 需求 3：加油站管理

**用户故事：** 作为超级管理员，我希望管理加油站信息，以便按地点组织设备。

#### 验收标准

1. 当用户访问加油站管理页面时，平台应显示加油站列表并支持分页
2. 当超级管理员创建新加油站时，平台应保存名称、编号、地址、联系人和电话信息
3. 当超级管理员编辑加油站时，平台应更新加油站信息
4. 当超级管理员删除加油站时，平台应检查是否有绑定设备，如有则阻止删除
5. 平台应支持按名称或编号搜索加油站
6. 当用户查看加油站详情时，平台应显示已绑定的室内机和室外机列表

### 需求 4：设备管理

**用户故事：** 作为超级管理员，我希望管理设备，以便跟踪和配置室内机和室外机。

#### 验收标准

1. 当设备首次发送 MQTT 消息时，平台应自动注册该设备并记录其 IMEI
2. 当用户访问设备管理页面时，平台应显示所有设备列表
3. 平台应显示设备信息，包括：IMEI、类型、绑定的加油站、在线状态、最后在线时间、电池电量
4. 当超级管理员将室内机绑定到加油站时，平台应检查该加油站是否已有室内机，如有则拒绝绑定
5. 当超级管理员将室外机绑定到加油站时，平台应允许绑定，不限制数量
6. 当超级管理员解绑设备时，平台应移除绑定关系
7. 平台应支持按设备类型、在线状态、绑定的加油站筛选设备
8. 平台应支持按 IMEI 或加油站名称搜索设备

### 需求 5：设备在线状态

**用户故事：** 作为用户，我希望查看设备在线状态，以便监控设备连接情况。

#### 验收标准

1. 当设备发送任何 MQTT 消息时，平台应更新该设备的最后在线时间
2. 当设备的最后在线时间超过 13 小时时，平台应将该设备标记为离线
3. 平台应使用可视化图标显示在线状态（绿色表示在线，红色表示离线）
4. 当室外机上报的电池电压低于 3300mV 时，平台应显示低电量警告
5. 平台应在监控页面定时刷新设备状态

### 需求 6：MQTT 消息转发

**用户故事：** 作为系统运维人员，我希望平台能在设备之间转发 MQTT 消息，以便室内机和室外机能够通信。

#### 验收标准

1. 当室内机发布报警消息时，MQTT转发服务应将消息转发给同一加油站绑定的所有室外机
2. 当室外机发布状态消息时，MQTT转发服务应将消息转发给同一加油站绑定的室内机
3. 如果设备未绑定任何加油站，MQTT转发服务应忽略该消息
4. MQTT转发服务应订阅主题 /AIR8000/PUB/+ 和 /780EHV/PUB/+
5. MQTT转发服务应发布到主题 /AIR8000/SUB/{IMEI} 和 /780EHV/SUB/{IMEI}

### 需求 7：报警日志

**用户故事：** 作为用户，我希望查看报警历史记录，以便追踪报警事件和响应情况。

#### 验收标准

1. 当室内机发送报警消息（bj=1）时，平台应创建一条报警日志记录
2. 当室内机发送取消报警消息（bj=0）时，平台应创建一条取消日志记录
3. 平台应记录以下信息：时间、加油站名称、室内机 IMEI、报警类型、转发的室外机 IMEI 列表、转发状态
4. 当用户访问报警日志页面时，平台应按时间倒序显示日志
5. 平台应支持按加油站、报警类型、时间范围筛选日志
6. 平台应支持按加油站名称或 IMEI 搜索日志

### 需求 8：数据库自动创建

**用户故事：** 作为开发者，我希望数据库表能自动创建，以便简化部署流程。

#### 验收标准

1. 当应用启动时，平台应检查数据库表是否存在
2. 如果表不存在，平台应使用 SQLAlchemy ORM 自动创建所有必需的表
3. 平台应创建以下表：users（用户表）、stations（加油站表）、devices（设备表）、alarm_logs（报警日志表）、user_stations（用户-加油站关联表）

### 需求 9：部署方式

**用户故事：** 作为系统管理员，我希望能够简单地部署平台，以便在 Docker 容器中运行。

#### 验收标准

1. 平台应通过 Flask 托管 Vue3 前端静态文件
2. 平台应提供 RESTful JSON API 供前端调用
3. 平台应能通过单条命令启动：python app.py
4. 平台应从环境变量或配置文件读取数据库连接信息
