# 微信小程序设备绑定系统 - 需求文档

## 项目概述

开发一个微信小程序，用于加油站液位监控系统的设备绑定管理。小程序支持通过扫描二维码获取设备IMEI，实现室内机与室外机的绑定/解绑功能，数据与云端Web平台同步。

---

## 需求列表

### REQ-1: 用户登录
**描述**: 用户通过账号密码登录小程序

**用户故事**: 作为用户，我希望通过账号密码登录小程序，以便访问设备绑定管理功能

**验收标准**:
- 登录页面包含用户名、密码输入框和登录按钮
- 使用现有Flask后端的 `/api/auth/login` 接口进行认证
- 登录成功后保存token到本地存储
- 登录失败显示错误提示（用户名或密码错误、账号被禁用等）
- 不区分管理员和普通用户，所有用户都可登录使用
- 所有用户看到的数据相同（加油站、设备全局共享，不做用户隔离）
- 支持退出登录功能

---

### REQ-2: 加油站管理 - 列表查看
**描述**: 查看所有加油站列表

**用户故事**: 作为用户，我希望查看所有加油站列表，以便了解当前系统中的加油站信息

**验收标准**:
- 显示加油站列表，包含名称、编号、地址等基本信息
- 支持下拉刷新获取最新数据
- 点击加油站可进入详情/编辑页面
- 显示每个加油站已绑定的设备数量（室内机/室外机）

---

### REQ-3: 加油站管理 - 新建加油站
**描述**: 创建新的加油站

**用户故事**: 作为用户，我希望新建加油站并录入基本信息，以便后续绑定设备

**验收标准**:
- 提供新建加油站入口
- 录入信息包括：加油站名称（必填）、加油站编号（必填）、地址、联系人、联系电话
- 提交后调用后端API创建加油站
- 创建成功后返回列表页并刷新

---

### REQ-4: 加油站管理 - 编辑加油站
**描述**: 编辑加油站基本信息

**用户故事**: 作为用户，我希望编辑加油站信息，以便更新或修正加油站资料

**验收标准**:
- 可修改加油站名称、编号、地址、联系人、联系电话
- 保存后同步到云端

---

### REQ-5: 加油站管理 - 删除加油站
**描述**: 删除加油站

**用户故事**: 作为用户，我希望删除不再使用的加油站

**验收标准**:
- 删除前需二次确认
- 如果加油站下有绑定设备，提示需先解绑设备
- 删除成功后刷新列表

---

### REQ-6: 设备绑定 - 扫码绑定室内机
**描述**: 通过扫描二维码绑定室内机到加油站

**用户故事**: 作为用户，我希望扫描室内机二维码将其绑定到加油站，以便建立设备与加油站的关联

**验收标准**:
- 在加油站详情页提供"扫码绑定室内机"按钮
- 调用微信扫码API扫描二维码
- 扫描结果直接作为IMEI（无需格式处理）
- 每个加油站只能绑定1台室内机
- 如果已有室内机绑定，提示需先解绑
- 设备未开机也支持绑定（设备不存在时自动创建）
- 绑定成功后显示设备信息

---

### REQ-7: 设备绑定 - 扫码绑定室外机
**描述**: 通过扫描二维码绑定室外机到加油站

**用户故事**: 作为用户，我希望扫描室外机二维码将其绑定到加油站，以便建立设备与加油站的关联

**验收标准**:
- 在加油站详情页提供"扫码绑定室外机"按钮
- 调用微信扫码API扫描二维码
- 扫描结果直接作为IMEI（无需格式处理）
- 每个加油站可绑定多台室外机
- 设备未开机也支持绑定（设备不存在时自动创建）
- 绑定成功后显示设备信息

---

### REQ-8: 设备解绑
**描述**: 解除设备与加油站的绑定关系

**用户故事**: 作为用户，我希望解绑设备，以便将设备转移到其他加油站或移除不再使用的设备

**验收标准**:
- 在加油站详情页显示已绑定的设备列表
- 每个设备提供"解绑"操作
- 解绑前需二次确认
- 解绑成功后刷新设备列表

---

### REQ-9: 设备管理 - 设备列表
**描述**: 查看所有设备列表

**用户故事**: 作为用户，我希望查看所有设备，以便了解设备的绑定状态和在线状态

**验收标准**:
- 显示所有设备列表
- 显示设备IMEI、类型（室内机/室外机）、绑定的加油站名称
- 显示设备在线状态（在线/离线，基于13小时离线判定规则）
- 支持按设备类型筛选
- 支持下拉刷新
- 未绑定的设备显示"未绑定"状态

---

### REQ-10: 设备管理 - 手动添加设备
**描述**: 手动输入IMEI添加设备

**用户故事**: 作为用户，我希望手动输入IMEI添加设备，以便在无法扫码时也能添加设备

**验收标准**:
- 提供手动添加设备入口
- 输入IMEI和选择设备类型（室内机/室外机）
- 添加成功后刷新设备列表
- 如果IMEI已存在，提示设备已存在

---

### REQ-11: 个人中心
**描述**: 显示账户信息和退出登录功能

**用户故事**: 作为用户，我希望查看我的账户信息并能够退出登录

**验收标准**:
- 显示当前登录用户名
- 显示用户角色（管理员/普通用户）
- 提供退出登录按钮
- 退出登录后清除本地token，跳转到登录页

---

### REQ-12: 数据同步
**描述**: 小程序数据与云端Web平台保持同步

**用户故事**: 作为用户，我希望小程序的操作能实时同步到云端，Web端的修改也能在小程序看到

**验收标准**:
- 所有增删改操作通过API同步到云端
- 进入页面时获取最新数据
- 支持手动刷新获取最新数据
- 数据全局共享，所有用户看到相同的加油站和设备数据（不做用户数据隔离）

---

## 页面结构

```
小程序页面结构:
├── 登录页 (login)
│   └── 账号密码登录
├── 首页/Tab页
│   ├── 加油站管理 (stations)
│   │   ├── 加油站列表
│   │   ├── 新建加油站
│   │   └── 加油站详情/编辑
│   │       ├── 基本信息编辑
│   │       ├── 已绑定设备列表（显示在线状态）
│   │       ├── 扫码绑定室内机
│   │       ├── 扫码绑定室外机
│   │       └── 设备解绑
│   ├── 设备管理 (devices)
│   │   ├── 设备列表（显示在线状态、绑定状态）
│   │   └── 手动添加设备
│   └── 个人中心 (profile)
│       ├── 账户信息（用户名、角色）
│       └── 退出登录
```

---

## 技术方案

### 前端技术栈
- 微信小程序原生开发
- TypeScript
- 使用现有模板 `WxBindingSystem`

### 后端接口
后端接口可复用现有Web端API，也可独立创建小程序专用API模块，以代码清晰、模块化为原则。

**可复用的现有接口**：
- `POST /api/auth/login` - 登录
- `GET /api/auth/me` - 获取当前用户
- `GET /api/stations` - 获取加油站列表
- `POST /api/stations` - 创建加油站
- `PUT /api/stations/:id` - 更新加油站
- `DELETE /api/stations/:id` - 删除加油站
- `GET /api/devices` - 获取设备列表
- `POST /api/devices` - 创建设备
- `POST /api/devices/:imei/bind` - 绑定设备到加油站
- `POST /api/devices/:imei/unbind` - 解绑设备

**需要新增的接口**：
- `GET /api/stations/:id` - 获取单个加油站详情（包含已绑定设备列表及在线状态）

### 接口模块化建议
如需独立小程序API模块，可创建 `backend/app/api/miniapp/` 目录，将小程序专用接口放置其中，便于后续维护和扩展。

---

## 版本规划

### V1.0 (MVP)
- 用户登录/退出
- 个人中心（账户信息、退出登录）
- 加油站CRUD
- 扫码绑定/解绑设备
- 手动添加设备
- 设备列表查看（含在线状态）
- 数据云端同步
